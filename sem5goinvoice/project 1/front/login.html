<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
     integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" 
     integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="login.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="js/validation.js"></script>
    <script src="js/schema-validator.js"></script>
    <script src="js/api-handler.js"></script>
</head>
<body>
    <div class="container">
      <div class="left-section">
        <img src="../images/invoologin.png" alt="GoInvoice preview" class="dashboard-image">
      </div>
      <div class="right-section">
        <h1>Go Invoice</h1>
        <h2>Login to Your Account</h2>
        <form class="form" id="loginForm" method="post" novalidate>
          <input type="email" id="email" name="email" placeholder="Email" required />
          <input type="password" id="password" name="password" placeholder="Password" required />
          <button type="submit" class="send-otp">Login</button>
          <a class="login" href="singup.html">Create New Account</a>
        </form>
        <div id="message" style="margin: 20px 0; color: red;"></div>
        <a href="" class="back-link">← Back to GoInvoice.Com</a>
      <footer>
        <p>Copyright © 2025 Go Invoice - Best GST Billing Software. All rights reserved.</p>
      </footer>
      </div>
   
    </div>
 
  
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Set dynamic year in footer
        const yEl = document.getElementById('copyYear');
        if (yEl) { yEl.textContent = new Date().getFullYear(); }

        // Clean accidental GET query params
        if (window.location.search) {
          history.replaceState({}, document.title, window.location.pathname);
        }

        // Normalize links and image when using VS Code Live Server so PHP runs on XAMPP
        const isLiveServer = /^(127\.0\.0\.1|localhost):55\d{2}$/.test(window.location.host);
        if (isLiveServer) {
          const signup = document.querySelector('a.login');
          if (signup) signup.href = 'http://localhost/sem5goinvoice/project%201/front/singup.html';
          const back = document.querySelector('a.back-link');
          if (back) back.href = 'http://localhost/sem5goinvoice/project%201/front/main.html';
          const img = document.querySelector('img.dashboard-image');
          if (img) img.src = 'http://localhost/sem5goinvoice/project%201/images/invoologin.png';
        }

        const form = document.getElementById('loginForm');
        const messageDiv = document.getElementById('message');
        const validator = new FormValidator();
        const schemaValidator = new SchemaValidator();
        let submitting = false;

        // If already logged in (valid session), go directly to dashboard
        apiHandler.checkSession().then((sess) => {
          if (sess && sess.logged_in) {
            const isLive = /^(127\.0\.0\.1|localhost):55\d{2}$/.test(window.location.host);
            const xamppUrl = 'http://localhost/sem5goinvoice/project%201/view/dashbord.php';
            window.location.replace(isLive ? xamppUrl : '../view/dashbord.php');
          }
        }).catch(() => {});

        validator.setupRealTimeValidation(form);

        // Form submission handler (guarded to prevent double submit)
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          if (submitting) { return; }
          submitting = true;
          // Clear previous messages
          messageDiv.textContent = '';
          messageDiv.className = '';
          // Validate form
          const { isValid, formData } = validator.validateForm(form);
          if (!isValid) {
            showMessage('Please fix the errors above', 'error');
            submitting = false;
            return;
          }
          // Schema validation
          const schemaResult = await schemaValidator.validateAndSanitize(formData, 'login');
          if (!schemaResult.valid) {
            showMessage('Validation failed: ' + schemaResult.errors.join(', '), 'error');
            submitting = false;
            return;
          }
          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Logging in...';
          try {
            // Use API handler with offline support
            const result = await offlineHandler.queueRequest(() =>
              apiHandler.login({
                email: (formData.email || '').trim(),
                password: formData.password
              })
            );
            if (result.success) {
              showMessage('Login successful! Redirecting...', 'success');
              try {
                if (result.data) {
                  localStorage.setItem('goinvoice_user', JSON.stringify(result.data));
                }
              } catch (_) {}
              setTimeout(() => {
                const isLive = /^(127\.0\.0\.1|localhost):55\d{2}$/.test(window.location.host);
                const xamppUrl = 'http://localhost/sem5goinvoice/project%201/view/dashbord.php';
                window.location.href = isLive ? xamppUrl : '../view/dashbord.php';
              }, 800);
            } else {
              showMessage(result.error || 'Login failed', 'error');
            }
          } catch (error) {
            console.error('Login error:', error);
            showMessage(error.message || 'Login failed. Please try again.', 'error');
          } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            submitting = false;
          }
        });

        function showMessage(message, type) {
          messageDiv.textContent = message;
          messageDiv.style.color = type === 'success' ? 'green' : 'red';
          messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
          if (type === 'success') {
            setTimeout(() => {
              messageDiv.textContent = '';
              messageDiv.className = '';
            }, 5000);
          }
        }
      });
    </script>
  </body>
  </html>